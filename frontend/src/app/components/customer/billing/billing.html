<div class="checkout-page">
  <header class="checkout-header">
    <div class="brand">
      <div class="logo-circle">E</div>
      <div>
        <div class="brand-name">ElectroPay</div>
        <div class="brand-subtitle">Paiement sÃ©curisÃ© de vos factures</div>
      </div>
    </div>

    <div class="header-right">
      <button class="link-button" (click)="reloadBills()" [disabled]="isLoading">
        ğŸ”„ {{ isLoading ? 'Chargement...' : 'Actualiser' }}
      </button>
      <button class="link-button" routerLink="/customer/orders" style="margin-left: 10px;">
        ğŸ“‹ Mes commandes
      </button>
      <button class="link-button" routerLink="/customer/cart" style="margin-left: 10px;">
        ğŸ›’ Mon panier
      </button>
    </div>
  </header>

  <main class="checkout-main">
    <!-- RÃ©sumÃ© facture -->
    <section class="card order-card">
      <div class="card-header">
        <h2>Vos factures</h2>
        <!-- CORRECTION ICI : Utilisez getUnpaidCount() au lieu du filtre inline -->
        <div class="badge" *ngIf="bills.length > 0">
          {{ getUnpaidCount() }} impayÃ©e(s)
        </div>
      </div>

      <div *ngIf="isLoading" class="loading-state">
        <div class="spinner"></div>
        <p>Chargement de vos factures...</p>
      </div>

      <div *ngIf="errorMessage && !isLoading" class="alert alert-error">
        <span>âŒ {{ errorMessage }}</span>
        <button class="retry-btn" (click)="loadUnpaidBills()">RÃ©essayer</button>
      </div>

      <div *ngIf="bills.length === 0 && !isLoading" class="empty-state">
        <div class="empty-icon">ğŸ“„</div>
        <h3>Aucune facture trouvÃ©e</h3>
        <p>Vous n'avez pas de facture en attente de paiement.</p>
        <p class="small-text">
          AprÃ¨s validation d'une commande, une nouvelle facture apparaÃ®tra ici.
        </p>
        <div class="empty-actions">
          <button class="secondary-button" (click)="loadUnpaidBills()">
            VÃ©rifier Ã  nouveau
          </button>
          <button class="secondary-button" routerLink="/shop">
            Continuer vos achats
          </button>
        </div>
      </div>

      <ng-container *ngIf="bills.length > 0 && selectedBill as bill">
        <div class="field">
          <label>SÃ©lectionnez une facture</label>
          <select class="select" [ngModel]="bill.id" (ngModelChange)="onBillChange($event)">
            <option *ngFor="let b of bills" [value]="b.id">
              Facture #{{ b.id }} - {{ b.totalAmount | number: '1.2-2' }} â‚¬
              ({{ getStatusLabel(b.status) }})
            </option>
          </select>
          <small class="hint">{{ bills.length }} facture(s) disponible(s)</small>
        </div>

        <div class="bill-meta">
          <div>
            <div class="meta-label">Client</div>
            <div class="meta-value">
              {{ bill.customer.firstName }} {{ bill.customer.lastName }}
            </div>
            <div class="meta-small">{{ bill.customer.email }}</div>
          </div>
          <div>
            <div class="meta-label">Date de facturation</div>
            <div class="meta-value">
              {{ bill.billDate | date: 'dd/MM/yyyy' }}
            </div>
            <div class="meta-small">{{ bill.billDate | date: 'HH:mm' }}</div>
          </div>
          <div>
            <div class="meta-label">Statut</div>
            <span [ngClass]="getStatusChipClass(bill.status)">
              {{ getStatusLabel(bill.status) }}
            </span>
          </div>
        </div>

        <div class="items-section">
          <h3>DÃ©tails de la facture</h3>
          <div class="items-table">
            <div class="items-header">
              <span class="item-desc">Description</span>
              <span class="item-qty">QuantitÃ©</span>
              <span class="item-price">Prix unitaire</span>
              <span class="item-total">Total</span>
            </div>
            <div class="items-body">
              <div class="items-row" *ngFor="let item of bill.items">
                <span class="item-desc">{{ item.description }}</span>
                <span class="item-qty">{{ item.quantity }}</span>
                <span class="item-price">{{ item.unitPrice | number: '1.2-2' }} â‚¬</span>
                <span class="item-total">{{ item.lineTotal | number: '1.2-2' }} â‚¬</span>
              </div>
            </div>
          </div>
        </div>

        <div class="total-line">
          <span>Total de la facture</span>
          <span class="total-amount">{{ bill.totalAmount | number: '1.2-2' }} â‚¬</span>
        </div>

        <div class="bill-actions">
          <button class="secondary-button" (click)="openPdf(bill)">
            ğŸ“„ TÃ©lÃ©charger le PDF
          </button>
          <button class="secondary-button" *ngIf="bill.status === 'PAID'">
            ğŸ“§ Envoyer par email
          </button>
        </div>
      </ng-container>
    </section>

    <!-- Bloc paiement -->
    <section class="card payment-card">
      <h2>ProcÃ©der au paiement</h2>

      <ng-container *ngIf="selectedBill as bill; else noBill">
        <div class="payment-status" [ngClass]="'status-' + bill.status.toLowerCase()">
          <div class="status-icon">
            <span *ngIf="bill.status === 'UNPAID'">â³</span>
            <span *ngIf="bill.status === 'PAID'">âœ…</span>
            <span *ngIf="bill.status === 'CANCELLED'">âŒ</span>
          </div>
          <div class="status-text">
            <strong>{{ getStatusLabel(bill.status) }}</strong>
            <small *ngIf="bill.status === 'UNPAID'">En attente de paiement</small>
            <small *ngIf="bill.status === 'PAID'">Facture rÃ©glÃ©e</small>
            <small *ngIf="bill.status === 'CANCELLED'">Facture annulÃ©e</small>
          </div>
        </div>

        <div *ngIf="bill.status === 'UNPAID'">
          <h3>MÃ©thode de paiement</h3>
          <div class="payment-methods">
            <button
              type="button"
              class="pill"
              [class.pill-active]="paymentMethod === 'CARD'"
              (click)="paymentMethod = 'CARD'"
            >
              ğŸ’³ Carte bancaire
            </button>
            <button
              type="button"
              class="pill"
              [class.pill-active]="paymentMethod === 'PAYPAL'"
              (click)="paymentMethod = 'PAYPAL'"
            >
              ğŸ…¿ï¸ PayPal
            </button>
            <button
              type="button"
              class="pill"
              [class.pill-active]="paymentMethod === 'BANK_TRANSFER'"
              (click)="paymentMethod = 'BANK_TRANSFER'"
            >
              ğŸ¦ Virement bancaire
            </button>
            <button
              type="button"
              class="pill"
              [class.pill-active]="paymentMethod === 'CASH'"
              (click)="paymentMethod = 'CASH'"
            >
              ğŸ’¶ EspÃ¨ces
            </button>
          </div>

          <!-- Formulaire carte -->
          <div *ngIf="paymentMethod === 'CARD'" class="card-form">
            <div class="field">
              <label>Nom sur la carte</label>
              <input class="input" type="text" placeholder="Ex : Jean Dupont" />
            </div>
            <div class="field">
              <label>NumÃ©ro de carte</label>
              <input class="input" type="text" placeholder="XXXX XXXX XXXX XXXX" />
            </div>
            <div class="field-row">
              <div class="field">
                <label>Date d'expiration</label>
                <input class="input" type="text" placeholder="MM/AA" />
              </div>
              <div class="field">
                <label>Code de sÃ©curitÃ© (CVV)</label>
                <input class="input" type="password" placeholder="***" />
              </div>
            </div>
          </div>

          <div *ngIf="paymentMethod === 'PAYPAL'" class="payment-info">
            <p>Vous serez redirigÃ© vers PayPal pour confirmer votre paiement.</p>
            <p class="small-text">Paiement sÃ©curisÃ© par PayPal.</p>
          </div>

          <div *ngIf="paymentMethod === 'BANK_TRANSFER'" class="payment-info">
            <p><strong>CoordonnÃ©es bancaires :</strong></p>
            <div class="bank-details">
              <p>IBAN: <code>FR76 1234 5678 9012 3456 7890 123</code></p>
              <p>BIC: <code>ABCDFRPP</code></p>
              <p>BÃ©nÃ©ficiaire: <strong>ElectroShop</strong></p>
              <p>RÃ©fÃ©rence: <strong>FACTURE-{{ bill.id }}</strong></p>
            </div>
          </div>

          <div *ngIf="paymentMethod === 'CASH'" class="payment-info">
            <p>Cette option est disponible uniquement en magasin.</p>
            <p>PrÃ©sentez votre numÃ©ro de facture <strong>#{{ bill.id }}</strong> Ã  la caisse.</p>
          </div>

          <div class="field">
            <label>Montant Ã  rÃ©gler</label>
            <div class="amount-input">
              <input
                type="number"
                min="0.01"
                [max]="bill.totalAmount"
                step="0.01"
                [(ngModel)]="paymentAmount"
                class="input"
                [class.input-error]="paymentAmount && (paymentAmount > bill.totalAmount || paymentAmount <= 0)"
              />
              <span class="currency">â‚¬</span>
            </div>
            <small class="hint">
              Montant total de la facture : <strong>{{ bill.totalAmount | number: '1.2-2' }} â‚¬</strong>
            </small>
            <small class="error-hint" *ngIf="paymentAmount && paymentAmount > bill.totalAmount">
              Le montant ne peut pas dÃ©passer {{ bill.totalAmount | number: '1.2-2' }} â‚¬
            </small>
          </div>

          <button
            class="primary-button"
            (click)="paySelectedBill()"
            [disabled]="isPaying || !paymentAmount || paymentAmount <= 0 || paymentAmount > bill.totalAmount"
          >
            <span *ngIf="!isPaying">
              Payer {{ (paymentAmount || bill.totalAmount) | number: '1.2-2' }} â‚¬
            </span>
            <span *ngIf="isPaying">
              <span class="spinner-small"></span>
              Traitement en cours...
            </span>
          </button>

          <p class="secure-info">
            ğŸ”’ Paiement 100% sÃ©curisÃ© - Vos donnÃ©es sont cryptÃ©es
          </p>
        </div>

        <div *ngIf="bill.status === 'PAID'" class="paid-info">
          <div class="success-message">
            <span>âœ…</span>
            <div>
              <h3>Facture dÃ©jÃ  rÃ©glÃ©e</h3>
              <p>Cette facture a Ã©tÃ© payÃ©e. Vous pouvez tÃ©lÃ©charger le reÃ§u en PDF.</p>
            </div>
          </div>
        </div>

        <div *ngIf="bill.status === 'CANCELLED'" class="cancelled-info">
          <div class="error-message">
            <span>âŒ</span>
            <div>
              <h3>Facture annulÃ©e</h3>
              <p>Cette facture a Ã©tÃ© annulÃ©e et ne peut plus Ãªtre payÃ©e.</p>
            </div>
          </div>
        </div>

        <div *ngIf="successMessage" class="alert alert-success">
          <span>âœ…</span>
          <div>{{ successMessage }}</div>
        </div>

        <div *ngIf="errorMessage" class="alert alert-error">
          <span>âŒ</span>
          <div>{{ errorMessage }}</div>
        </div>
      </ng-container>

      <ng-template #noBill>
        <div class="no-bill-selected">
          <div class="no-bill-icon">ğŸ“‹</div>
          <h3>Aucune facture sÃ©lectionnÃ©e</h3>
          <p>SÃ©lectionnez une facture dans la liste Ã  gauche pour voir les dÃ©tails et procÃ©der au paiement.</p>
          <p class="small-text">
            Si vous venez de valider une commande, votre facture apparaÃ®tra ici aprÃ¨s quelques secondes.
          </p>
        </div>
      </ng-template>
    </section>
  </main>

  <footer class="checkout-footer">
    <p>Â© 2024 ElectroPay - Service de paiement sÃ©curisÃ©</p>
    <p class="small-text">
      <a href="#">Conditions gÃ©nÃ©rales</a> â€¢
      <a href="#">Politique de confidentialitÃ©</a> â€¢
      <a href="#">Aide</a>
    </p>
  </footer>
</div>
