<div class="container">
  <h2 class="mb-4">Gestion des Magasiniers</h2>

  <!-- Avertissement si pas admin -->
  <div *ngIf="!isAdminUser" class="alert alert-warning">
    <h4 class="alert-heading">Accès non autorisé</h4>
    <p>Vous devez être connecté avec un compte administrateur pour accéder à cette page.</p>
    <hr>
    <div class="d-flex gap-2">
      <button class="btn btn-primary" routerLink="/login">Se connecter</button>
      <button class="btn btn-secondary" routerLink="/dashboard">Retour au tableau de bord</button>
    </div>
  </div>

  <!-- Contenu admin -->
  <div *ngIf="isAdminUser">

    <!-- Messages d'erreur/succès -->
    <div *ngIf="errorMessage" class="alert alert-danger alert-dismissible fade show">
      <i class="bi bi-exclamation-triangle me-2"></i>
      {{ errorMessage }}
      <button type="button" class="btn-close" (click)="clearMessagesImmediate()"></button>
    </div>

    <div *ngIf="successMessage" class="alert alert-success alert-dismissible fade show">
      <i class="bi bi-check-circle me-2"></i>
      {{ successMessage }}
      <button type="button" class="btn-close" (click)="clearMessagesImmediate()"></button>
    </div>

    <!-- Formulaire -->
    <div class="card mb-4 shadow-sm">
      <div class="card-header bg-primary text-white">
        <h4 class="mb-0">{{ isEditing ? 'Modifier le magasinier' : 'Ajouter un nouveau magasinier' }}</h4>
      </div>
      <div class="card-body">
        <form (ngSubmit)="isEditing ? updateUser() : createUser()" #magasinierForm="ngForm">
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="firstName" class="form-label">Prénom <span class="text-danger">*</span></label>
              <input type="text" id="firstName" class="form-control"
                     [(ngModel)]="formData.firstName" name="firstName"
                     required
                     [class.is-invalid]="magasinierForm.submitted && !formData.firstName">
              <div class="invalid-feedback">
                Le prénom est requis
              </div>
            </div>

            <div class="col-md-6 mb-3">
              <label for="lastName" class="form-label">Nom <span class="text-danger">*</span></label>
              <input type="text" id="lastName" class="form-control"
                     [(ngModel)]="formData.lastName" name="lastName"
                     required
                     [class.is-invalid]="magasinierForm.submitted && !formData.lastName">
              <div class="invalid-feedback">
                Le nom est requis
              </div>
            </div>
          </div>

          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="email" class="form-label">Email <span class="text-danger">*</span></label>
              <input type="email" id="email" class="form-control"
                     [(ngModel)]="formData.email" name="email"
                     required
                     [class.is-invalid]="magasinierForm.submitted && !formData.email">
              <div class="invalid-feedback">
                Un email valide est requis
              </div>
            </div>

            <div class="col-md-6 mb-3">
              <label for="password" class="form-label">
                Mot de passe <span class="text-danger">{{ isEditing ? '' : '*' }}</span>
                <small class="text-muted ms-1">{{ isEditing ? '(laisser vide pour ne pas changer)' : '' }}</small>
              </label>
              <input type="password" id="password" class="form-control"
                     [(ngModel)]="formData.password" name="password"
                     [required]="!isEditing"
                     [minlength]="6"
                     [class.is-invalid]="magasinierForm.submitted && !isEditing && (!formData.password || formData.password.length < 6)">
              <div class="invalid-feedback" *ngIf="!isEditing">
                Le mot de passe doit avoir au moins 6 caractères
              </div>
              <small class="form-text text-muted" *ngIf="!isEditing">Minimum 6 caractères</small>
            </div>
          </div>

          <div class="d-flex gap-2 mt-4">
            <button type="submit" class="btn btn-primary" [disabled]="loading">
              <span *ngIf="loading" class="spinner-border spinner-border-sm me-2"></span>
              <i class="bi" [class.bi-check]="!isEditing" [class.bi-pencil]="isEditing"></i>
              {{ isEditing ? 'Mettre à jour' : 'Ajouter' }}
            </button>
            <button type="button" class="btn btn-secondary"
                    *ngIf="isEditing" (click)="cancelEdit()" [disabled]="loading">
              <i class="bi bi-x-circle me-1"></i>
              Annuler
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Liste des magasiniers -->
    <div class="card shadow-sm">
      <div class="card-header bg-light d-flex justify-content-between align-items-center">
        <h4 class="mb-0">
          <i class="bi bi-people me-2"></i>
          Liste des magasiniers
          <span class="badge bg-secondary ms-2">{{ users.length }}</span>
        </h4>
        <div>
          <button class="btn btn-sm btn-outline-primary" (click)="loadUsers()" [disabled]="loading">
            <i class="bi bi-arrow-clockwise" *ngIf="!loading"></i>
            <span class="spinner-border spinner-border-sm" *ngIf="loading"></span>
            {{ loading ? 'Chargement...' : 'Actualiser' }}
          </button>
        </div>
      </div>
      <div class="card-body">

        <!-- Loading -->
        <div *ngIf="loading" class="text-center py-5">
          <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status">
            <span class="visually-hidden">Chargement...</span>
          </div>
          <p class="mt-3 text-muted">Chargement des magasiniers...</p>
        </div>

        <!-- Table -->
        <div *ngIf="!loading && users.length > 0">
          <div class="table-responsive">
            <table class="table table-hover table-striped">
              <thead class="table-dark">
              <tr>
                <th>Prénom</th>
                <th>Nom</th>
                <th>Email</th>
                <th>Rôle</th>
                <th class="text-center">Actions</th>
              </tr>
              </thead>
              <tbody>
              <tr *ngFor="let user of users">
                <td class="align-middle">{{ user.firstName }}</td>
                <td class="align-middle">{{ user.lastName }}</td>
                <td class="align-middle">
                  <a href="mailto:{{ user.email }}" class="text-decoration-none">
                    <i class="bi bi-envelope me-1"></i>
                    {{ user.email }}
                  </a>
                </td>
                <td class="align-middle">
                    <span class="badge bg-success">
                      <i class="bi bi-person-gear me-1"></i>
                      MAGASINIER
                    </span>
                </td>
                <td class="align-middle text-center">
                  <div class="btn-group btn-group-sm" role="group">
                    <button class="btn btn-outline-warning"
                            (click)="editUser(user)"
                            title="Modifier"
                            [disabled]="loadingUserId === user.id">
                      <i class="bi bi-pencil"></i>
                      Modifier
                    </button>
                    <button class="btn btn-outline-danger ms-1"
                            (click)="deleteUser(user)"
                            [disabled]="loadingUserId === user.id"
                            title="Supprimer">
                      <i class="bi bi-trash" *ngIf="loadingUserId !== user.id"></i>
                      <span class="spinner-border spinner-border-sm" *ngIf="loadingUserId === user.id"></span>
                      {{ loadingUserId === user.id ? 'Suppression...' : 'Supprimer' }}
                    </button>
                  </div>
                </td>
              </tr>
              </tbody>
            </table>
          </div>

          <div class="text-muted small mt-3">
            <i class="bi bi-info-circle me-1"></i>
            {{ users.length }} magasinier{{ users.length > 1 ? 's' : '' }} trouvé{{ users.length > 1 ? 's' : '' }}
          </div>
        </div>

        <!-- Aucun magasinier -->
        <div *ngIf="!loading && users.length === 0" class="text-center py-5">
          <i class="bi bi-person-plus display-1 text-muted"></i>
          <h4 class="mt-3 text-muted">Aucun magasinier trouvé</h4>
          <p class="text-muted">Commencez par ajouter un nouveau magasinier en utilisant le formulaire ci-dessus.</p>
        </div>
      </div>
    </div>
  </div>
</div>
